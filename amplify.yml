# AWS Amplify Build Configuration for Next.js App Router
# 
# IMPORTANT: Environment variables must be set in the Amplify Console:
# 1. Go to Hosting > Environment variables
# 2. Add all variables from .env.example
# 3. Make sure to set NEXTAUTH_URL to your Amplify app URL
#
# NOTE: Amplify env vars are only available at BUILD time by default.
# This config creates a .env.production file to make them available at RUNTIME.

version: 1

# Build settings for the frontend
frontend:
  phases:
    # Pre-build phase: Install dependencies and create runtime env file
    preBuild:
      commands:
        # Print Node.js and npm versions for debugging
        - echo "Node.js version:" && node --version
        - echo "npm version:" && npm --version
        
        # Install dependencies
        - npm ci --legacy-peer-deps
        
        # CRITICAL: Create .env.production file for runtime access
        # Amplify env vars are only available at build time, so we write them to a file
        - echo "Creating .env.production for runtime environment variables..."
        - |
          cat << EOF > .env.production
          # Auto-generated by Amplify build - DO NOT COMMIT
          # These variables will be available at runtime
          
          # Supabase
          NEXT_PUBLIC_SUPABASE_URL=$NEXT_PUBLIC_SUPABASE_URL
          NEXT_PUBLIC_SUPABASE_ANON_KEY=$NEXT_PUBLIC_SUPABASE_ANON_KEY
          SUPABASE_SERVICE_ROLE_KEY=$SUPABASE_SERVICE_ROLE_KEY
          
          # NextAuth
          NEXTAUTH_URL=$NEXTAUTH_URL
          NEXTAUTH_SECRET=$NEXTAUTH_SECRET
          
          # Google OAuth
          GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
          GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
          
          # Optional: Redis (if configured)
          UPSTASH_REDIS_REST_URL=$UPSTASH_REDIS_REST_URL
          UPSTASH_REDIS_REST_TOKEN=$UPSTASH_REDIS_REST_TOKEN
          
          # Optional: Cloudflare R2 (if configured)
          CLOUDFLARE_R2_ACCESS_KEY_ID=$CLOUDFLARE_R2_ACCESS_KEY_ID
          CLOUDFLARE_R2_SECRET_ACCESS_KEY=$CLOUDFLARE_R2_SECRET_ACCESS_KEY
          CLOUDFLARE_R2_BUCKET_NAME=$CLOUDFLARE_R2_BUCKET_NAME
          CLOUDFLARE_R2_ENDPOINT=$CLOUDFLARE_R2_ENDPOINT
          CLOUDFLARE_R2_PUBLIC_URL=$CLOUDFLARE_R2_PUBLIC_URL
          CLOUDFLARE_ACCOUNT_ID=$CLOUDFLARE_ACCOUNT_ID
          GEOIP_SERVICE_URL=$GEOIP_SERVICE_URL
          
          # Optional: Gemini AI (if configured)
          GEMINI_API_KEY=$GEMINI_API_KEY
          EOF
        
        # Verify the file was created
        - echo "✓ .env.production file created"
        - echo "Checking required environment variables..."
        
        # Verify environment variables are set (without exposing values)
        - |
          if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ]; then
            echo "❌ ERROR: NEXT_PUBLIC_SUPABASE_URL is not set"
          else
            echo "✓ NEXT_PUBLIC_SUPABASE_URL is set"
          fi
        - |
          if [ -z "$NEXT_PUBLIC_SUPABASE_ANON_KEY" ]; then
            echo "❌ ERROR: NEXT_PUBLIC_SUPABASE_ANON_KEY is not set"
          else
            echo "✓ NEXT_PUBLIC_SUPABASE_ANON_KEY is set"
          fi
        - |
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "❌ ERROR: SUPABASE_SERVICE_ROLE_KEY is not set"
          else
            echo "✓ SUPABASE_SERVICE_ROLE_KEY is set"
          fi
        - |
          if [ -z "$NEXTAUTH_SECRET" ]; then
            echo "❌ ERROR: NEXTAUTH_SECRET is not set"
          else
            echo "✓ NEXTAUTH_SECRET is set"
          fi
        - |
          if [ -z "$NEXTAUTH_URL" ]; then
            echo "❌ ERROR: NEXTAUTH_URL is not set"
          else
            echo "✓ NEXTAUTH_URL is set"
          fi
        - |
          if [ -z "$GOOGLE_CLIENT_ID" ]; then
            echo "❌ ERROR: GOOGLE_CLIENT_ID is not set"
          else
            echo "✓ GOOGLE_CLIENT_ID is set"
          fi
        - |
          if [ -z "$GOOGLE_CLIENT_SECRET" ]; then
            echo "❌ ERROR: GOOGLE_CLIENT_SECRET is not set"
          else
            echo "✓ GOOGLE_CLIENT_SECRET is set"
          fi
    
    # Build phase: Build the Next.js application
    build:
      commands:
        # Set NODE_ENV for production build
        - echo "Building Next.js application..."
        - NODE_ENV=production npm run build
        
        # Copy .env.production to standalone directory for runtime access
        - echo "Copying environment file to standalone output..."
        - cp .env.production .next/standalone/.env.production 2>/dev/null || echo "Standalone directory structure may differ"
        
        # Also copy to the root of .next for safety
        - cp .env.production .next/.env.production
        
        # Verify build output
        - echo "Build completed. Checking output..."
        - ls -la .next/
    
    # Post-build phase: Prepare for deployment
    postBuild:
      commands:
        - echo "Post-build phase completed"
        - echo "Environment variables configured for runtime access"
  
  # Artifacts to deploy - Next.js with App Router
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
      - '.env.production'
  
  # Cache settings for faster builds
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*

