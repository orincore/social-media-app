# AWS Amplify Build Configuration
# This file configures how AWS Amplify builds and deploys the Next.js application
# 
# IMPORTANT: Environment variables must be set in the Amplify Console:
# 1. Go to App settings > Environment variables
# 2. Add all variables from .env.example
# 3. Make sure to set NEXTAUTH_URL to your Amplify app URL

version: 1

# Build settings for the frontend
frontend:
  phases:
    # Pre-build phase: Install dependencies
    preBuild:
      commands:
        # Print Node.js and npm versions for debugging
        - echo "Node.js version:" && node --version
        - echo "npm version:" && npm --version
        
        # Install dependencies
        - npm ci --legacy-peer-deps
        
        # Verify environment variables are set (without exposing values)
        - echo "Checking required environment variables..."
        - |
          if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ]; then
            echo "WARNING: NEXT_PUBLIC_SUPABASE_URL is not set"
          else
            echo "✓ NEXT_PUBLIC_SUPABASE_URL is set"
          fi
        - |
          if [ -z "$NEXT_PUBLIC_SUPABASE_ANON_KEY" ]; then
            echo "WARNING: NEXT_PUBLIC_SUPABASE_ANON_KEY is not set"
          else
            echo "✓ NEXT_PUBLIC_SUPABASE_ANON_KEY is set"
          fi
        - |
          if [ -z "$NEXTAUTH_SECRET" ]; then
            echo "WARNING: NEXTAUTH_SECRET is not set"
          else
            echo "✓ NEXTAUTH_SECRET is set"
          fi
        - |
          if [ -z "$GOOGLE_CLIENT_ID" ]; then
            echo "WARNING: GOOGLE_CLIENT_ID is not set"
          else
            echo "✓ GOOGLE_CLIENT_ID is set"
          fi
    
    # Build phase: Build the Next.js application
    build:
      commands:
        # Set NODE_ENV for production build
        - echo "Building Next.js application..."
        - NODE_ENV=production npm run build
        
        # Verify build output
        - echo "Build completed. Checking output..."
        - ls -la .next/
    
    # Post-build phase: Prepare for deployment
    postBuild:
      commands:
        - echo "Post-build phase completed"
        - echo "Standalone output ready for deployment"
  
  # Artifacts to deploy
  artifacts:
    # Next.js standalone output
    baseDirectory: .next
    files:
      - '**/*'
  
  # Cache settings for faster builds
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*

# Custom headers for security and performance
customHeaders:
  - pattern: '**/*'
    headers:
      - key: 'X-Frame-Options'
        value: 'DENY'
      - key: 'X-Content-Type-Options'
        value: 'nosniff'
      - key: 'X-XSS-Protection'
        value: '1; mode=block'
      - key: 'Referrer-Policy'
        value: 'strict-origin-when-cross-origin'
  
  - pattern: '/api/*'
    headers:
      - key: 'Cache-Control'
        value: 'no-store, no-cache, must-revalidate'
  
  - pattern: '/_next/static/**'
    headers:
      - key: 'Cache-Control'
        value: 'public, max-age=31536000, immutable'

# Rewrites for Next.js routing
rewrites:
  # API routes
  - source: '/api/<*>'
    target: '/api/<*>'
    status: '200'
  
  # Next.js image optimization
  - source: '/_next/image'
    target: '/_next/image'
    status: '200'
  
  # Static files
  - source: '/_next/static/<*>'
    target: '/_next/static/<*>'
    status: '200'
  
  # Catch-all for Next.js pages
  - source: '/<*>'
    target: '/index.html'
    status: '200'
